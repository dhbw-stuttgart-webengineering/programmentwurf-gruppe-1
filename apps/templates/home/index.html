{% extends "layouts/base-fullscreen.html" %} 
{% block title %} Home {%endblock title %} 
{% block content %}

<main class="grid-container">
  <div class="grades">
    {% if request.user.is_authenticated %}
    <p>Willkommen, {{ request.user.name }}!</p>
    {% else %}
    <p>Du bist nicht eingeloggt!</p>
    {% endif %} 
  
    <h2>Eigene Noten</h2>
    <table aria-describedby="grades-summary">
      <thead>
        <tr>
          <th>Kurs</th>
          <th>Note (1. Versuch)</th>
          <th>Note (2. Versuch)</th>
          {% if grade.grade_first_attempt is not null %}
            <th>Vergleich</th>
          {% endif %}
          
        </tr>
      </thead>
      <tbody>
        {% for module in own_grades %}
          {% for grade in module.units %}
          <tr>
              <td>{{ grade.unit_name }}</td>
              <td>
                  {% if grade.grade_first_attempt is not null %}
                    {{ grade.grade_first_attempt }}
                  {% else %}
                    N/A
                  {% endif %}
              </td>
              <td>
                  {% if grade.grade_second_attempt %}
                      {{ grade.grade_second_attempt }}
                  {% else %}
                      N/A
                  {% endif %}
              </td>
              {% if grade.grade_first_attempt is not null %}
              <td><button class="compareButton" type="button"  onclick="compareCharts({{ grade|safe }})">Vergleich</button></td>
              {% endif %}
          </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="chart-box">
    <div class="compare">
      <canvas id="comparechart"></canvas>
    </div>
  </div>

  <div class="chart-box">
    <br/>
    <div class="miss">
      <canvas id="misschart"></canvas>
    </div>
  </div>
</main>

<style>
  .grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Zwei Spalten */
    grid-template-rows: 1fr 1fr; /* Automatische Höhe */
    gap: 20px; /* Abstand zwischen den Spalten */
  }

  .grades, .chart-box {
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    max-width: 500px;
    width: 100%; /* Jede Box nimmt die gesamte verfügbare Breite */
    
  }

  .grades {
    grid-column: 1 / 2; /* Position in erster Spalte */
    grid-row: 1 / 3; /* Position in erster Zeile */
  }

  .chart-box {
    grid-column: 2 / 3; /* Position in zweiter Spalte */
    margin-bottom: 20px; /* Abstand zwischen den Diagrammen */
    display: flex; /* Elemente als Flexbox behandeln */
    justify-content: center; /* Inhalt horizontal zentrieren */
    align-items: center; /* Inhalt vertikal zentrieren */
    
  }
  #comparechart{
    grid-row: 1 / 2; /* Position in erster Zeile */
   
  }

  #misschart {
    grid-row: 2 / 3; /* Position in zweiter Zeile */
  }

  table {
    border-collapse: collapse;
    width: 100%;
}

th, td {
    text-align: left;
    padding: 8px;
}

</style>

<script>
  function compareCharts(grade) {
    var coursename = grade.course;
    var compareChartCtx = removeAndCreateCanvas('comparechart');
    var missChartCtx = removeAndCreateCanvas('misschart');

    var compareChartCtx = document.getElementById('comparechart').getContext('2d');
    var missChartCtx = document.getElementById('misschart').getContext('2d');

    var compareChartData = generateRandomChartData();
    var missChartData = generateRandomMissChartData();

    var compareChart = new Chart(compareChartCtx, {
      type: 'bar',
      data: {
        labels: ['Kurs A', 'Kurs B', 'Kurs C', 'Kurs D'],
        datasets: [{
          label: 'Durchschnittsnoten - ' + coursename,
          data: compareChartData,
          backgroundColor: generateRandomColors(4),
          borderColor: 'rgba(255, 255, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            min: 1,
            max: 6,
          }
        },
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Kursvergleich - ' + coursename
          }
        }
      }
    });

    var missChart = new Chart(missChartCtx, {
      type: 'doughnut',
      data: {
        labels: ["Durchgefallen", "Bestanden"],
        datasets: [
          {
            data: missChartData,
            backgroundColor: [
              "rgba(255, 99, 132, 0.5)",
              "rgba(75, 192, 192, 0.5)",
            ],
            borderColor: ["rgba(255,99,132,1)", "rgba(75, 192, 192, 1)"],
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "top",
          },
          title: {
            display: true,
            text: "Prüfungsergebnisse",
          },
        },
      },
    });
    
  }
  
  function generateRandomColors(numColors) {
    var colors = [];
    for (let i = 0; i < numColors; i++) {
      var randomColor = 'rgba(' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ', 0.5)';
      colors.push(randomColor);
    }
    return colors;
  }
  function generateRandomChartData() {
    return [Math.random() * 5 + 1, Math.random() * 5 + 1, Math.random() * 5 + 1, Math.random() * 5 + 1];
  }

  function generateRandomMissChartData() {
    return [Math.random(), Math.random()];
  }

  function removeAndCreateCanvas(chartId) {
    var oldCanvas = document.getElementById(chartId);
  
    if (oldCanvas) {
      // Canvas-Element entfernen
      oldCanvas.parentNode.removeChild(oldCanvas);
    }
  
    // Neues Canvas-Element erstellen
    var newCanvas = document.createElement('canvas');
    newCanvas.id = chartId;
    
    // Dem gewünschten Container hinzufügen
    if (chartId == 'comparechart') {
      var container = document.querySelector('.compare');  // Wähle comparechart aus
    } else {
      var container = document.querySelector('.miss');  // Wähle misschart aus
    }
    container.appendChild(newCanvas);
  
    return newCanvas.getContext('2d');
  }

  </script>

{% endblock content %}
